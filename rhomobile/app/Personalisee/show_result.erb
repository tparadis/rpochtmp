<!DOCTYPE html>
<html>
<head>
 <style>
   #map {
     width: 390px;
     height: 530px;
   }
 </style>

<script src="/public/customjs/detailsCommerce.js"></script>
<script src="/public/customjs/choixParcours.js"></script>
<script src="/public/customjs/geoloc.js"></script>

 <script>
 
 var waypointsArray =[];
 var i = 0;
 var lat=0;
 var lng = 0;
 var markerArray = [];
 var infowindowArray = [];
   var L = [];
   
  function initialize() {    
    var magasins=[];
    for (var i = 0 ; i < sessionStorage.length ; i++) {
        var magasin = JSON.parse(sessionStorage.getItem(i));
          alert(getImagePath(magasin[0],magasin[2]));
        var image = {url:getImagePath(magasin[0],magasin[2]),
          size: new google.maps.Size(32, 32),
          origin: new google.maps.Point(0, 0),
          anchor: new google.maps.Point(16, 16)
        };
        magasins.push({"image":image,"latitude":magasin[4],"longitude":magasin[5],"name":magasin[3]});
      }

     var directionsService = new google.maps.DirectionsService;
     var directionsDisplay = new google.maps.DirectionsRenderer;
     var mapCanvas = document.getElementById('map');
     var position;
   
   
     var mapOptions = {
       center: new google.maps.LatLng(48.112739, -1.681489),
       zoom: 15,
       mapTypeId: google.maps.MapTypeId.ROADMAP
     }
     var map = new google.maps.Map(mapCanvas, mapOptions);

     userMarker = new google.maps.Marker({
            position: {lat: userlat, lng: userlong},
            map: map,
            icon: "http://rpoch.istic.univ-rennes1.fr/static/images/googlePos.png"
          });
          
          window.setInterval(function()
          {
            userMarker.setPosition({lat: userlat, lng: userlong});
           },2000); 
     
     for(i=0;i<magasins.length;i++)
     {
               lat = magasins[i].latitude;
               lng = magasins[i].longitude;
               if(i!=0&&i!=magasins.length-1)
                 {waypointsArray.push({
                                    location:new google.maps.LatLng(lat, lng),
                                    stopover:false
                                  }); 
                 }      
                 var marker =new google.maps.Marker({
                                      position: new google.maps.LatLng(magasins[i].latitude, magasins[i].longitude),
                                      map: map,
                                      icon: magasins[i].image
                                      });   
                 attachMessage(marker, magasins[i].name);           
       
};

    var request = {
       origin:new google.maps.LatLng(magasins[0].latitude,magasins[1].longitude),
           /*FIXME si le parcours a moins de deux points l'application va planter*/
         destination:new google.maps.LatLng(magasins[magasins.length-1].latitude,magasins[magasins.length-1].longitude),
         optimizeWaypoints: true,
         waypoints: waypointsArray,
         travelMode: google.maps.TravelMode.WALKING
       };
       directionsService.route(request, function(result, status) {
         if (status == google.maps.DirectionsStatus.OK) {
           directionsDisplay.setDirections(result);
         }
       });
         directionsDisplay.setMap(map);
         directionsDisplay.setOptions( { suppressMarkers: true } );    }  
           
//Permet d assigner le titre au marker.
//-----    
function attachMessage(marker, message) {
var infowindow = new google.maps.InfoWindow({
content: message
});  marker.addListener('click', function() {
infowindow.open(marker.get('map'), marker);
});
}
//----- 
   </script>
</head>
<body>


<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBcpbC-OR2Xbq5JcUAOaDrEgoOGxN5St9w&signed_in=true&callback=initialize"
 async defer></script>  <div id="map"></div>
</body>
</html>