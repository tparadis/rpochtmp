<!DOCTYPE html>
<html>
<head>
  <style>
    #map {
      width: 390px;
      height: 530px;
    }
  </style>
  <script>
  var perso = "<%= $parcours_perso%>" 
  var points = perso.split(",");
  var waypointsArray =[];
  var i = 0;
  var lat=0;
  var lng = 0;
  
  
    function initialize() {

      var directionsService = new google.maps.DirectionsService;
      var directionsDisplay = new google.maps.DirectionsRenderer;
      var mapCanvas = document.getElementById('map');
      var mapOptions = {
        center: new google.maps.LatLng(48.112739, -1.681489),
        zoom: 15,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      }
      var map = new google.maps.Map(mapCanvas, mapOptions)
      
      for(i=3;i<points.length-4;i++)
        {
            switch (i%3){
              case 0:
                lat = points[i];
                break;
              case 1:
                lng = points[i];
                break;
              case 2:
                waypointsArray.push({
                  location:new google.maps.LatLng(lat, lng),
                  stopover:true
                });
                //window.alert(lat);
                //window.alert(lng);
                break;
            }
        }

      //window.alert(waypointsArray[0]);
      
     
      directionsDisplay.setMap(map);
      
      var request = {
          origin:new google.maps.LatLng(points[0], points[1]),
            /*FIXME si le parcours a moins de deux points l'application va planter*/
          destination:new google.maps.LatLng(points[points.length-4], points[points.length-3]),
          optimizeWaypoints: true,
          waypoints: waypointsArray,
          travelMode: google.maps.TravelMode.WALKING
        };
        directionsService.route(request, function(result, status) {
          if (status == google.maps.DirectionsStatus.OK) {
            directionsDisplay.setDirections(result);
          }
        });

    }

    
    </script>
</head>
<body>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAfh64T7GInE-G0rPQ35PHjmPr1erbaJgg&signed_in=true&callback=initialize"
  async defer></script>

  <div id="map"></div>
</body>
</html>