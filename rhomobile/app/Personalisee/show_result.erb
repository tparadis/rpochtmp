<!DOCTYPE html>
<html>
<head>
 <style>
   #map {
     width: 390px;
     height: 530px;
   }
 </style>
<script src="/public/js/rhogeolocation.js"></script>
 <script>
 
 var waypointsArray =[];
 var i = 0;
 var lat=0;
 var lng = 0;
 var markerArray = [];
 var infowindowArray = [];
   var L = [];

   
  function initialize() {    
    
    var res ="";
    
    for (var i = 0 ; i < sessionStorage.length ; i++) {
        var magasin = JSON.parse(sessionStorage.getItem(i));
        res=res.concat(magasin[4],",",magasin[5],",",magasin[3],",");
      }
     var points = res.split(",");  
    var directionsService = new google.maps.DirectionsService;
     var directionsDisplay = new google.maps.DirectionsRenderer;
     var mapCanvas = document.getElementById('map');
     var position;
   
   
     var mapOptions = {
       center: new google.maps.LatLng(48.112739, -1.681489),
       zoom: 15,
       mapTypeId: google.maps.MapTypeId.ROADMAP
     }
     var map = new google.maps.Map(mapCanvas, mapOptions);
     
     userMarker = new google.maps.Marker({
            position: {lat: getLat(), lng: getLong()},
            map: map,
            icon: "http://rpoch.istic.univ-rennes1.fr/static/images/googlePos.png"
          });
          
          window.setInterval(function()
          {
            userMarker.setPosition({lat: getLat(), lng: getLong()});
           },2000); 
     
     for(i=0;i<points.length;i++)
       {
           switch (i%3){
             case 0:
               lat = points[i];
               break;
             case 1:
               lng = points[i];
               break;
             case 2:
               waypointsArray.push({
                 location:new google.maps.LatLng(lat, lng),
                 stopover:false
               });
               
               //-----
               
               var marker =new google.maps.Marker({
                                      position: new google.maps.LatLng(lat, lng),
                                      map: map
                                    });
                                   
               attachMessage(marker, points[i]);
              //-----
               break;
           }
       }
 
    var request = {
       origin:new google.maps.LatLng(points[0],points[1]),
           /*FIXME si le parcours a moins de deux points l'application va planter*/
         destination:new google.maps.LatLng(points[points.length-4], points[points.length-3]),
         optimizeWaypoints: true,
         waypoints: waypointsArray,
         travelMode: google.maps.TravelMode.WALKING
       };
       directionsService.route(request, function(result, status) {
         if (status == google.maps.DirectionsStatus.OK) {
           directionsDisplay.setDirections(result);
         }
       });
         directionsDisplay.setMap(map);
         directionsDisplay.setOptions( { suppressMarkers: true } );    }  
           
//Permet d assigner le titre au marker.
//-----    
function attachMessage(marker, message) {
var infowindow = new google.maps.InfoWindow({
content: message
});  marker.addListener('click', function() {
infowindow.open(marker.get('map'), marker);
});
}
//----- 
   </script>
</head>
<body>

<geolongitude style="opacity:0;"></geolongitude>
<geolocation style="opacity:0;"></geolocation>
<geolatitude style="opacity:0;"></geolatitude>


<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBcpbC-OR2Xbq5JcUAOaDrEgoOGxN5St9w&signed_in=true&callback=initialize"
 async defer></script>  <div id="map"></div>
 

<script src="/public/customjs/geoloc.js"></script>
</body>
</html>